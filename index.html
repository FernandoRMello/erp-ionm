<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Gestão IONM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader, .loader-white { border: 2px solid #f3f3f3; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        .loader { border-top: 2px solid #3498db; }
        .loader-white { border-top: 2px solid #fff; display: inline-block; }
        .page-content { display: none; } /* Oculta seções até serem selecionadas */
        #main-nav a.active, #user-main-nav a.active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        #user-main-nav a.active { background-color: #4f46e5; color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto;}
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 90%; max-width: 600px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .nav-heading { padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        /* Feedback Elements */
        .loading-spinner-container { text-align: center; padding: 2rem; }
        .error-message-container { background-color: #fee2e2; border: 1px solid #f87171; color: #b91c1c; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
         /* Estilo para o resumo gerado */
        #report-summary-container { background-color: #eef2ff; border-left: 4px solid #4f46e5; padding: 1rem; margin-top: 1.5rem; border-radius: 0.25rem; }
        #report-summary-text { color: #3730a3; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app">
        <!-- SEÇÃO DE LOGIN -->
        <div id="login-section" class="min-h-screen flex flex-col items-center justify-center p-4"></div>
        
        <!-- PAINEL DE ADMINISTRAÇÃO -->
        <div id="admin-panel-section" style="display: none;">
            <div class="relative min-h-screen md:flex">
                <div id="admin-sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 md:hidden" style="display: none;"></div>
                <div class="bg-white text-gray-900 flex justify-between md:hidden sticky top-0 z-10 shadow">
                    <a href="#" class="block p-4 font-bold text-indigo-600">Gestão IONM</a>
                    <button id="admin-menu-button" class="p-4 focus:outline-none focus:bg-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
                <aside id="admin-sidebar" class="w-64 bg-slate-50 border-r border-slate-200 flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out">
                    <div class="p-6 text-center"><h1 class="text-2xl font-bold text-indigo-600">Gestão IONM</h1></div>
                    <nav id="main-nav" class="flex-1 px-4 space-y-1">
                        <a href="#" data-target="dashboard-main-section" class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors">Dashboard</a>
                        <div class="pt-4 pb-2">
                            <h3 class="nav-heading">Cadastros</h3>
                            <a href="#" data-target="empresas-main-section" class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors">Empresas</a>
                            <a href="#" data-target="usuarios-main-section" class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors">Usuários</a>
                            <a href="#" data-target="modulos-main-section" class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors">Módulos</a>
                        </div>
                        <div class="pt-4 pb-2">
                            <h3 class="nav-heading">Gerencial</h3>
                            <a href="#" data-target="assinaturas-main-section" class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors">Assinaturas</a>
                            <a href="#" data-target="financeiro-main-section" class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors">Financeiro</a>
                            <a href="#" data-target="comercial-main-section" class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors">Comercial</a>
                            <a href="#" data-target="relatorios-main-section" class="flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-200 transition-colors">Relatórios</a>
                        </div>
                    </nav>
                    <div class="p-4 border-t border-slate-200"><button id="logout-button" class="w-full text-left bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">Sair</button></div>
                </aside>
                <main id="content-area" class="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-100">
                    <!-- Content sections will be dynamically loaded here -->
                    <div id="dashboard-main-section" class="page-content"></div>
                    <div id="empresas-main-section" class="page-content"></div>
                    <div id="usuarios-main-section" class="page-content"></div>
                    <div id="modulos-main-section" class="page-content"></div>
                    <div id="assinaturas-main-section" class="page-content"></div>
                    <div id="financeiro-main-section" class="page-content"></div>
                    <div id="comercial-main-section" class="page-content"></div>
                    <div id="relatorios-main-section" class="page-content"></div>
                </main>
            </div>
        </div>

        <!-- PAINEL DO USUÁRIO (ERP) -->
        <div id="user-erp-panel-section" style="display: none;">
             <div class="relative min-h-screen md:flex">
                <div id="user-sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 md:hidden" style="display: none;"></div>
                <div class="bg-indigo-800 text-white flex justify-between md:hidden sticky top-0 z-10">
                    <a href="#" class="block p-4 font-bold">ERP IONM</a>
                    <button id="user-menu-button" class="p-4 focus:outline-none focus:bg-indigo-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
                <aside id="user-sidebar" class="w-64 bg-indigo-800 text-white flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out">
                    <div class="p-6 text-center"><h1 class="text-2xl font-bold">ERP IONM</h1></div>
                    <nav id="user-main-nav" class="flex-1 px-4 space-y-2"></nav>
                    <div class="p-4 border-t border-indigo-700">
                        <div id="user-info" class="text-sm mb-4"></div>
                        <button id="user-logout-button" class="w-full text-left bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">Sair</button>
                    </div>
                </aside>
                <main id="user-content-area" class="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-100"></main>
             </div>
        </div>
        <div id="modal-container"></div>
    </div>

    <script>
    console.log("Script principal iniciado."); 

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM completamente carregado e pronto."); 

        let state = { currentUser: null };
        const ADMIN_USER = { email: 'fernando.mello@ionm', password: 'Dr@g3378' };
        const DOM = { 
            app: document.getElementById('app'),
            loginSection: document.getElementById('login-section'),
            adminPanel: document.getElementById('admin-panel-section'),
            userPanel: document.getElementById('user-erp-panel-section'),
            adminSidebar: document.getElementById('admin-sidebar'),
            adminSidebarOverlay: document.getElementById('admin-sidebar-overlay'),
            userSidebar: document.getElementById('user-sidebar'),
            userSidebarOverlay: document.getElementById('user-sidebar-overlay'),
            contentArea: document.getElementById('content-area'), 
            userContentArea: document.getElementById('user-content-area') 
        };

        const useMockApi = window.location.protocol === 'blob:'; // True se estiver no preview
        // --- API Definition (realApi and mockApi as before) ---
        const realApi = { get: (endpoint) => fetch(`/api/${endpoint}`).then(res => { if(!res.ok) throw new Error(`HTTP error! status: ${res.status}`); return res.json(); }), post: (endpoint, body) => fetch(`/api/${endpoint}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(res => res.json().then(data => { if(!res.ok) throw new Error(data.error || `HTTP error! status: ${res.status}`); return data; })) };
        const MOCK_DB = { companies: [{id: 1, nome_fantasia: 'Loja Mock LTDA', razao_social: 'Comércio Mock LTDA', address: 'Rua Mock, 123', ie: '123', company_type: 'LTDA', business_branch: 'COMERCIO', billing_day: 5, contract_end_date: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(), user_limit: 5 }], users: [{id: 1, name: 'Usuário Mock', email: 'user@mock.com', login_user: 'user.mock', password: '123', company_id: 1, user_type: 'ADMINISTRADOR', company_name: 'Loja Mock LTDA'}], modules: [{id: 1, module_name: 'Controle de Estoque', monthly_cost_brl: 19.90, allowed_user_types: ['ESTOQUE', 'GERENTE', 'ADMINISTRADOR'], applicable_business_branches: ['COMERCIO']}, {id: 2, module_name: 'Financeiro', monthly_cost_brl: 59.90, allowed_user_types: ['GERENTE', 'ADMINISTRADOR'], applicable_business_branches: ['COMERCIO']}], subscriptions: [{company_id: 1, module_id: 1},{company_id: 1, module_id: 2}] };
        const mockApi = { get: (endpoint) => new Promise((resolve, reject) => { setTimeout(() => { const [path, params] = endpoint.split('?'); const query = new URLSearchParams(params); switch (path) { case 'get-dashboard-data': resolve({ total_companies: MOCK_DB.companies.length, total_users: MOCK_DB.users.length, total_monthly_revenue: '79.80', revenue_by_day: { '5': '79.80', '10': '0.00', '15': '0.00', '20': '0.00', '25': '0.00' }, companies_nearing_expiration: MOCK_DB.companies.filter(c => (new Date(c.contract_end_date) - Date.now()) < 7 * 24 * 60 * 60 * 1000), company_monthly_costs: { '1': 79.80 } }); break; case 'get-companies': resolve(MOCK_DB.companies); break; case 'get-users': resolve(MOCK_DB.users); break; case 'get-modules': resolve(MOCK_DB.modules); break; case 'get-company-details': resolve(MOCK_DB.companies.find(c => c.id == query.get('id')) || {}); break; case 'get-subscription-management': const mgmtData = MOCK_DB.companies.map(c => ({...c, current_users: MOCK_DB.users.filter(u => u.company_id === c.id).length})); resolve(mgmtData); break; case 'get-subscriptions-by-company': resolve(MOCK_DB.subscriptions.filter(s => s.company_id == query.get('companyId')).map(s => s.module_id)); break; default: reject('Endpoint GET não encontrado no mock: ' + path); } }, 300); }), post: (endpoint, body) => new Promise((resolve, reject) => { setTimeout(() => { switch (endpoint) { case 'login-user': const user = MOCK_DB.users.find(u => u.login_user === body.login_user && u.password === body.password); if (user) { const company = MOCK_DB.companies.find(c => c.id === user.company_id); const companySubs = MOCK_DB.subscriptions.filter(s => s.company_id === user.company_id).map(s => s.module_id); const permittedModules = MOCK_DB.modules.filter(m => companySubs.includes(m.id) && m.applicable_business_branches.includes(company.business_branch) && m.allowed_user_types.includes(user.user_type)); resolve({ user, permittedModules, token: `mock-token-${user.id}` }); } else { reject(new Error('Usuário ou senha inválidos.')); } break; case 'logout-user': console.log("MOCK API: Logout chamado", body); resolve({ success: true, message: 'Logout simulado com sucesso.' }); break; case 'create-company': MOCK_DB.companies.push({ ...body, id: Date.now(), contract_end_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), user_limit: 5 }); resolve({ message: 'Success' }); break; case 'create-user': MOCK_DB.users.push({ ...body, id: Date.now(), company_name: MOCK_DB.companies.find(c=> c.id == body.company_id)?.nome_fantasia }); resolve({ message: 'Success' }); break; case 'create-module': MOCK_DB.modules.push({ ...body, id: Date.now() }); resolve({ message: 'Success' }); break; case 'update-company': const compIdx = MOCK_DB.companies.findIndex(c => c.id == body.id); if(compIdx > -1) MOCK_DB.companies[compIdx] = { ...MOCK_DB.companies[compIdx], ...body }; resolve({ message: 'Success' }); break; case 'update-user-limit': const limitIdx = MOCK_DB.companies.findIndex(c => c.id == body.companyId); if(limitIdx > -1) MOCK_DB.companies[limitIdx].user_limit = body.newUserLimit; resolve({ message: 'Success' }); break; case 'update-subscriptions': MOCK_DB.subscriptions = MOCK_DB.subscriptions.filter(s => s.company_id != body.companyId); body.moduleIds.forEach(moduleId => MOCK_DB.subscriptions.push({ company_id: body.companyId, module_id: moduleId })); resolve({ message: 'Success' }); break; case 'renew-contract': const renewIdx = MOCK_DB.companies.findIndex(c => c.id == body.companyId); if (renewIdx > -1) { const d = new Date(MOCK_DB.companies[renewIdx].contract_end_date); d.setDate(d.getDate() + parseInt(body.renewalPeriodDays, 10)); MOCK_DB.companies[renewIdx].contract_end_date = d.toISOString(); } resolve({ message: 'Success' }); break; case 'generate-report-summary': resolve({ summary: `✨ Resumo gerado por IA para ${body.reportName}: Este é um resumo de exemplo dos dados fornecidos.` }); break; case 'generate-product-description': resolve({ description: `✨ Descrição gerada por IA para ${body.productName}: Uma descrição curta e atraente.`}); break; default: reject(new Error('Endpoint POST não encontrado no mock: ' + endpoint)); } }, 500); }) };
        const api = useMockApi ? mockApi : realApi;

        // --- Template HTML para Feedback ---
        const loadingSpinnerHTML = `<div class="loading-spinner-container"><div class="loader mx-auto mt-10"></div><p class="text-slate-500 mt-2">A carregar...</p></div>`;
        const errorMessageHTML = (message) => `<div class="error-message-container">
            <strong class="font-bold">Ocorreu um erro!</strong>
            <span class="block sm:inline">${message || 'Não foi possível carregar os dados.'}</span>
        </div>`;

        async function handleLogin(formElement) { 
            console.log("handleLogin chamado com form:", formElement); // Log
            const btn = formElement.querySelector('button[type="submit"]');
            const errorEl = document.getElementById('login-error'); // Assume ID fixo
            const loginField = formElement.querySelector('#login_field');
            const passwordField = formElement.querySelector('#password');
            
            if (!btn || !errorEl || !loginField || !passwordField) {
                 console.error("handleLogin: Elementos essenciais do formulário não encontrados.");
                 if(btn) btn.disabled = false;
                 return;
            }

            const login = loginField.value;
            const password = passwordField.value;
            
            console.log("Tentando login para:", login);
            
            btn.disabled = true;
            btn.innerHTML = '<div class="loader-white mx-auto"></div>';
            errorEl.textContent = '';
            try {
                if (login === ADMIN_USER.email && password === ADMIN_USER.password) {
                    console.log("Credenciais de admin OK.");
                    localStorage.setItem('authToken', 'admin-token-' + Date.now()); 
                    DOM.loginSection.style.display = 'none';
                    DOM.adminPanel.style.display = 'block';
                    await navigateToSection('dashboard-main-section');
                    console.log("Navegado para dashboard admin.");
                } else {
                    console.log("Tentando login de utilizador comum...");
                    const { user, permittedModules, token } = await api.post('login-user', { login_user: login, password }); 
                    console.log("Login de utilizador comum OK:", user.name);
                    state.currentUser = { ...user, modules: permittedModules };
                    if(token) localStorage.setItem('authToken', token); 
                    renderUserERP();
                    console.log("Painel ERP renderizado.");
                }
            } catch (error) {
                console.error("handleLogin: Erro durante o login:", error);
                errorEl.textContent = error.message || "Credenciais inválidas ou erro no servidor.";
                btn.disabled = false;
                btn.innerHTML = 'Entrar';
            }
        }

        async function handleLogout() { /* ... (Lógica como na versão anterior, incluindo chamada api.post('logout-user',...)) */ }
        function renderUserERP() { /* ... (Lógica como na versão anterior) */ }
        
        async function renderPage(pageId, targetEl) {
            const pageContent = targetEl; 
            if (!pageContent) { console.error("Elemento alvo não encontrado:", targetEl ? targetEl.id : 'undefined'); return; }
            const template = pageTemplates[pageId];
            if (!template) { console.error("Template não encontrado para pageId:", pageId); pageContent.innerHTML = errorMessageHTML("Funcionalidade não encontrada."); return; }
            
            pageContent.innerHTML = loadingSpinnerHTML; 
            try {
                // Se o template for uma função async, espera. Senão, usa o resultado diretamente.
                const content = typeof template === 'function' ? await template() : template;
                pageContent.innerHTML = content; 
            } catch (error) {
                console.error(`Erro ao renderizar a página ${pageId}:`, error);
                pageContent.innerHTML = errorMessageHTML(error.message); 
            }
        }

        async function navigateToSection(targetId) {
             console.log("Navegando para:", targetId); 
             document.querySelectorAll('#main-nav a').forEach(link => link.classList.toggle('active', link.dataset.target === targetId));
             document.querySelectorAll('#admin-panel-section .page-content').forEach(section => section.style.display = 'none'); 
             const targetSection = document.getElementById(targetId);
             if(targetSection) {
                targetSection.style.display = 'block';
                await renderPage(targetId, targetSection); 
             } else {
                 console.error("Seção alvo não encontrada:", targetId);
                 DOM.contentArea.innerHTML = errorMessageHTML(`A seção "${targetId}" não foi encontrada.`);
             }
             // Fecha menus mobile ao navegar
             DOM.adminSidebar.classList.add('-translate-x-full');
             DOM.adminSidebarOverlay.style.display = 'none';
        }
        function showModal(content) { /* ... (Lógica como na versão anterior) */ }
        function closeModal() { /* ... (Lógica como na versão anterior) */ }
        async function renderReportView(reportId, moduleName) { /* ... (Lógica como na versão anterior com chamada API Gemini) */ }
        const createTableHTML = (headers, rows, actions = []) => { /* ... (Lógica como na versão anterior) */ };

        const moduleFileNames = { /* ... (Lógica como na versão anterior) */ };
        
        // --- Templates das páginas --- 
        // Templates estáticos simplificados para retornar strings diretamente
        const pageTemplates = {
            'dashboard-main-section': async () => { try { const data = await api.get('get-dashboard-data'); state.dashboardData = data; return `<h2 class="text-3xl font-bold mb-6">Dashboard Gerencial</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">...</div>`; } catch(e){ throw e;} }, // Conteúdo completo omitido
            'empresas-main-section': () => `<h2 class="text-2xl font-bold mb-6">Gestão de Empresas</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><button data-page="company-registration-page" class="page-nav-button bg-white p-6 rounded-xl shadow hover:shadow-lg text-left"><h3 class="text-lg font-bold">Cadastrar Empresa</h3></button><button data-page="company-list-page" class="page-nav-button bg-white p-6 rounded-xl shadow hover:shadow-lg text-left"><h3 class="text-lg font-bold">Listar Empresas</h3></button></div>`,
            'usuarios-main-section': () => `<h2 class="text-2xl font-bold mb-6">Gestão de Usuários</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><button data-page="user-registration-page" class="page-nav-button bg-white p-6 rounded-xl shadow hover:shadow-lg text-left"><h3 class="text-lg font-bold">Cadastrar Usuário</h3></button><button data-page="user-list-page" class="page-nav-button bg-white p-6 rounded-xl shadow hover:shadow-lg text-left"><h3 class="text-lg font-bold">Listar Usuários</h3></button></div>`,
            'modulos-main-section': () => `<h2 class="text-2xl font-bold mb-6">Gestão de Módulos</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><button data-page="module-registration-page" class="page-nav-button bg-white p-6 rounded-xl shadow hover:shadow-lg text-left"><h3 class="text-lg font-bold">Cadastrar Módulo</h3></button><button data-page="module-list-page" class="page-nav-button bg-white p-6 rounded-xl shadow hover:shadow-lg text-left"><h3 class="text-lg font-bold">Listar Módulos</h3></button><button data-page="module-link-page" class="page-nav-button bg-white p-6 rounded-xl shadow hover:shadow-lg text-left"><h3 class="text-lg font-bold">Vincular Módulos</h3></button></div>`,
            'assinaturas-main-section': async () => { try { const data = await api.get('get-subscription-management'); let content = `<h2 class="text-2xl font-bold mb-6">Gerenciamento de Assinaturas e Usuários</h2>`; content += `<div class="bg-white p-6 rounded-xl shadow">...</div>`; return content; } catch(e){ throw e;} }, // Conteúdo completo omitido
            'financeiro-main-section': () => `<h2 class="text-2xl font-bold mb-6">Financeiro</h2>...`, // Conteúdo completo omitido
            'comercial-main-section': () => `<h2 class="text-2xl font-bold mb-6">Comercial</h2>...`, // Conteúdo completo omitido
            'relatorios-main-section': () => `<h2 class="text-2xl font-bold mb-6">Gestão de Relatórios</h2>...`, // Conteúdo completo omitido
            'company-registration-page': () => `<div><button data-page="empresas-main-section" ...>...</div>`, // Conteúdo completo omitido
            'user-registration-page': async () => { try { const companies = await api.get('get-companies'); return `<div><button data-page="usuarios-main-section" ...>...</div>`; } catch(e){ throw e;} }, // Conteúdo completo omitido
            'module-registration-page': () => `<div><button data-page="modulos-main-section" ...>...</div>`, // Conteúdo completo omitido
            'module-link-page': async () => { try { const [companies, modules] = await Promise.all([api.get('get-companies'), api.get('get-modules')]); return `<div><button data-page="modulos-main-section" ...>...</div>`; } catch(e){ throw e;} }, // Conteúdo completo omitido
            'company-list-page': async () => { try { const companies = await api.get('get-companies'); return `<div><button data-page="empresas-main-section" ...>...</div>`; } catch(e){ throw e;} }, // Conteúdo completo omitido
            'user-list-page': async () => { try { const users = await api.get('get-users'); return `<div><button data-page="usuarios-main-section" ...>...</div>`; } catch(e){ throw e;} }, // Conteúdo completo omitido
            'module-list-page': async () => { try { const modules = await api.get('get-modules'); return `<div><button data-page="modulos-main-section" ...>...</div>`; } catch(e){ throw e;} }, // Conteúdo completo omitido
        };
        
        // --- GERENCIADOR DE EVENTOS CENTRALIZADO ---
        DOM.app.addEventListener('submit', async (e) => {
            console.log("Evento submit capturado no app para o form:", e.target.id); // Log
            e.preventDefault(); // Garante que está aqui
            const form = e.target;
            if (!form || form.tagName !== 'FORM') return; 

            const btn = form.querySelector('button[type="submit"]');
            if (btn) btn.disabled = true; 
            const originalBtnText = btn ? btn.innerHTML : null; 
            if(btn) btn.innerHTML = '<div class="loader-white mx-auto"></div>'; 
            
            try {
                if (form.id === 'login-form') { 
                    console.log("Tratando submissão do login-form..."); // Log
                    await handleLogin(form); // << Passa o form (e.target)
                } 
                else if (form.id === 'company-form') { /* ... */ } 
                else if (form.id === 'user-form') { /* ... */ } 
                else if (form.id === 'module-form') { /* ... */ } 
                else if (form.id === 'edit-company-form') { /* ... */ }
                else if (form.id === 'update-user-limit-form') { /* ... */}
            } catch (error) { 
                console.error("Erro no formulário:", error);
                alert('Erro: ' + error.message); 
            } 
            finally { 
                if(btn) {
                    btn.disabled = false; 
                    if (originalBtnText) btn.innerHTML = originalBtnText; 
                }
            }
        });

        DOM.app.addEventListener('click', async (e) => { /* ... (Lógica de clique como na versão anterior) */ });
        function updateLoginPreview() { /* ... (sem alterações) */ }
        DOM.app.addEventListener('change', async (e) => { /* ... (sem alterações) */ });
        let cnpjTimeout;
        DOM.app.addEventListener('input', (e) => { /* ... (sem alterações) */ });

        function init() {
            console.log("Função init() chamada.");
            try {
                DOM.loginSection.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md"><h1 class="text-2xl font-bold text-center mb-6">Acesso à Plataforma</h1><form id="login-form"><div class="mb-4"><label for="login_field" class="block text-sm">Usuário ou Email</label><input type="text" id="login_field" class="w-full mt-1 px-4 py-2 border rounded-lg" required></div><div class="mb-6"><label for="password" class="block text-sm">Senha</label><input type="password" id="password" class="w-full mt-1 px-4 py-2 border rounded-lg" required></div><div id="login-error" class="text-red-500 text-sm text-center mb-4 h-5"></div><button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-400">Entrar</button></form></div>`;
                 console.log("Tela de login renderizada em init()."); 
                 const loginForm = document.getElementById('login-form');
                 if(!loginForm) {
                     console.error("init(): Formulário de login NÃO encontrado após renderização!");
                 } else {
                     console.log("init(): Formulário de login encontrado com sucesso.");
                 }
            } catch (renderError) {
                 console.error("init(): Erro ao renderizar tela de login:", renderError);
                 DOM.loginSection.innerHTML = errorMessageHTML("Erro crítico ao carregar a tela de login.");
            }
        }

        // Tenta inicializar a aplicação
        try {
             init();
             console.log("Aplicação inicializada com sucesso."); 
        } catch (error) {
            console.error("Erro fatal durante a inicialização:", error);
            DOM.app.innerHTML = errorMessageHTML("Erro crítico ao carregar a aplicação. Verifique o console.");
        }
    });
    </script>
</body>
</html>


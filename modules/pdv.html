<!-- Estilos específicos para o PDV -->
<style>
    /* Custom scrollbar for product list */
    #pdv-product-list::-webkit-scrollbar, #pdv-sale-items::-webkit-scrollbar {
        width: 8px;
    }
    #pdv-product-list::-webkit-scrollbar-track, #pdv-sale-items::-webkit-scrollbar-track {
        background: #f1f5f9;
    }
    #pdv-product-list::-webkit-scrollbar-thumb, #pdv-sale-items::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 4px;
    }
    #pdv-product-list::-webkit-scrollbar-thumb:hover, #pdv-sale-items::-webkit-scrollbar-thumb:hover {
        background: #64748b;
    }
    #reader {
        width: 100%;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
    }
</style>

<div id="pdv-container" class="grid grid-cols-1 lg:grid-cols-5 gap-6">

    <!-- Coluna de Produtos e Busca -->
    <div class="lg:col-span-3">
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h4 class="font-bold mb-4 text-lg">Produtos</h4>
            
            <!-- Campo de Busca e Câmera -->
            <div class="flex items-center gap-2 mb-4">
                <div class="relative flex-grow">
                    <input id="pdv-barcode-input" type="text" placeholder="Ler código de barras ou buscar por nome..." class="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    <svg class="w-5 h-5 absolute left-3 top-3.5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                </div>
                <button id="pdv-camera-btn" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition shadow">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                    </svg>
                </button>
            </div>

            <!-- Container da Câmera -->
            <div id="camera-container" class="mb-4" style="display: none;">
                <div id="reader"></div>
                <button id="close-camera-btn" class="w-full mt-2 bg-red-500 text-white p-2 rounded-lg">Fechar Câmera</button>
            </div>

            <!-- Lista de Produtos (Cardápio) -->
            <div id="pdv-product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto p-2 bg-slate-50 rounded-lg">
                <!-- Produtos serão inseridos aqui via JS -->
            </div>
        </div>
    </div>

    <!-- Coluna da Venda (Carrinho) -->
    <div class="lg:col-span-2">
        <div class="bg-white p-4 rounded-lg shadow-md sticky top-4">
            <h4 class="font-bold mb-4 text-lg border-b pb-2">Carrinho</h4>
            <div id="pdv-sale-items" class="max-h-64 overflow-y-auto mb-4 divide-y">
                <p class="text-slate-500 text-center py-8">Nenhum item adicionado.</p>
            </div>
            <div class="space-y-2 text-lg border-t pt-4">
                <div class="flex justify-between"><span>Subtotal</span><span id="pdv-subtotal">R$ 0,00</span></div>
                <div class="flex justify-between font-bold text-2xl"><span>TOTAL</span><span id="pdv-total" class="text-green-600">R$ 0,00</span></div>
            </div>
            <div class="mt-6">
                 <h5 class="font-bold mb-2">Forma de Pagamento</h5>
                 <div class="grid grid-cols-3 gap-2">
                     <button class="bg-slate-200 p-2 rounded-lg hover:bg-slate-300 transition">Dinheiro</button>
                     <button class="bg-slate-200 p-2 rounded-lg hover:bg-slate-300 transition">Cartão</button>
                     <button class="bg-slate-200 p-2 rounded-lg hover:bg-slate-300 transition">PIX</button>
                 </div>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-4">
                <button id="pdv-cancel-sale" class="bg-red-100 text-red-700 font-bold py-3 rounded-lg hover:bg-red-200 transition">Cancelar</button>
                <button id="pdv-finish-sale" class="bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition col-span-1">Finalizar Venda</button>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Relatórios -->
<div id="report-section-container"></div>

<!-- Biblioteca para scanner de QR/Barcode -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    (() => {
        const container = document.getElementById('pdv-container');
        if (!container) return;

        const productListEl = document.getElementById('pdv-product-list');
        const saleItemsEl = document.getElementById('pdv-sale-items');
        const subtotalEl = document.getElementById('pdv-subtotal');
        const totalEl = document.getElementById('pdv-total');
        const barcodeInput = document.getElementById('pdv-barcode-input');
        const cameraBtn = document.getElementById('pdv-camera-btn');
        const cameraContainer = document.getElementById('camera-container');
        const closeCameraBtn = document.getElementById('close-camera-btn');

        const mockProducts = [
            { id: 101, barcode: '789001', name: 'Produto A', price: 12.50, image: 'https://placehold.co/150x150/e2e8f0/64748b?text=A' },
            { id: 102, barcode: '789002', name: 'Produto B', price: 25.00, image: 'https://placehold.co/150x150/e2e8f0/64748b?text=B' },
            { id: 103, barcode: '789003', name: 'Produto C', price: 8.75, image: 'https://placehold.co/150x150/e2e8f0/64748b?text=C' },
            { id: 104, barcode: '789004', name: 'Serviço X', price: 150.00, image: 'https://placehold.co/150x150/e2e8f0/64748b?text=X' },
            { id: 105, barcode: '789005', name: 'Item Teste', price: 99.90, image: 'https://placehold.co/150x150/e2e8f0/64748b?text=Teste' },
            { id: 106, barcode: '789006', name: 'Acessório Y', price: 45.25, image: 'https://placehold.co/150x150/e2e8f0/64748b?text=Y' },
        ];
        let currentSale = [];
        let html5QrCode = null;

        function formatCurrency(value) { return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

        function renderProducts(filter = '') {
            if (!productListEl) return;
            const normalizedFilter = filter.toLowerCase();
            const filtered = mockProducts.filter(p => p.name.toLowerCase().includes(normalizedFilter) || p.barcode.includes(normalizedFilter));
            productListEl.innerHTML = filtered.map(p => `
                <button class="add-product-btn border rounded-lg p-2 text-center hover:bg-slate-100 hover:shadow-md transition" data-id="${p.id}">
                    <img src="${p.image}" alt="${p.name}" class="w-full h-24 object-cover rounded-md mb-2">
                    <span class="font-semibold block text-sm">${p.name}</span>
                    <span class="text-xs text-slate-600">${formatCurrency(p.price)}</span>
                </button>
            `).join('');
        }

        function renderSale() { /* ... (lógica interna, sem alterações) */ }
        function updateTotals() { /* ... (lógica interna, sem alterações) */ }

        function addProductById(productId) {
            const existingItem = currentSale.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                const product = mockProducts.find(p => p.id === productId);
                if (product) currentSale.push({ productId: product.id, name: product.name, price: product.price, quantity: 1 });
            }
            renderSale();
        }

        function addProductByBarcode(barcode) {
            const product = mockProducts.find(p => p.barcode === barcode);
            if(product) {
                addProductById(product.id);
                barcodeInput.value = ''; // Limpa o campo
                barcodeInput.focus();
            } else {
                alert('Produto não encontrado!');
            }
        }
        
        function updateQuantity(productId, change) { /* ... (lógica interna, sem alterações) */ }
        function removeItem(productId) { /* ... (lógica interna, sem alterações) */ }
        function cancelSale() { /* ... (lógica interna, sem alterações) */ }
        function finishSale() { /* ... (lógica interna, sem alterações) */ }

        function startCameraScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            cameraContainer.style.display = 'block';
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText, decodedResult) => {
                    addProductByBarcode(decodedText);
                    stopCameraScanner(); // Para o scanner após sucesso
                },
                (errorMessage) => { /* console.log(errorMessage); */ }
            ).catch(err => {
                alert("Erro ao iniciar a câmera. Verifique as permissões do navegador.");
                console.error(err);
                cameraContainer.style.display = 'none';
            });
        }

        function stopCameraScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    cameraContainer.style.display = 'none';
                }).catch(err => console.error("Erro ao parar a câmera", err));
            } else {
                cameraContainer.style.display = 'none';
            }
        }
        
        // --- Anexar Eventos ---
        container.addEventListener('click', (e) => {
            const addBtn = e.target.closest('.add-product-btn');
            const updateQtyBtn = e.target.closest('.update-qty-btn');
            const removeItemBtn = e.target.closest('.remove-item-btn');

            if (addBtn) addProductById(parseInt(addBtn.dataset.id, 10));
            if (updateQtyBtn) updateQuantity(parseInt(updateQtyBtn.dataset.id, 10), parseInt(updateQtyBtn.dataset.change, 10));
            if (removeItemBtn) removeItem(parseInt(removeItemBtn.dataset.id, 10));
            if (e.target.id === 'pdv-cancel-sale') cancelSale();
            if (e.target.id === 'pdv-finish-sale') finishSale();
            if (e.target.closest('#pdv-camera-btn')) startCameraScanner();
            if (e.target.closest('#close-camera-btn')) stopCameraScanner();
        });

        barcodeInput.addEventListener('input', (e) => renderProducts(e.target.value));
        barcodeInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                addProductByBarcode(e.target.value.trim());
            }
        });

        // --- Renderização Inicial ---
        renderProducts();
    })();
</script>

